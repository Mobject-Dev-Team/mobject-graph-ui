/**
 * MIT License
 *
 * Copyright (c) 2024 benhar-dev
 *
 * Permission is hereby granted, free of charge, to any person obtaining a copy
 * of this software and associated documentation files (the "Software"), to deal
 * in the Software without restriction, including without limitation the rights
 * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 * copies of the Software, and to permit persons to whom the Software is
 * furnished to do so, subject to the following conditions:
 *
 * The above copyright notice and this permission notice shall be included in all
 * copies or substantial portions of the Software.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 * SOFTWARE.
 */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var t=require("mobject-litegraph");t.LiteGraph.debug=!1,t.LiteGraph.logging_set_level(-1),t.LiteGraph.catch_exceptions=!0,t.LiteGraph.throw_errors=!0,t.LiteGraph.allow_scripts=!1,t.LiteGraph.searchbox_extras={},t.LiteGraph.auto_sort_node_types=!0,t.LiteGraph.node_box_coloured_when_on=!0,t.LiteGraph.node_box_coloured_by_mode=!0,t.LiteGraph.dialog_close_on_mouse_leave=!0,t.LiteGraph.dialog_close_on_mouse_leave_delay=500,t.LiteGraph.shift_click_do_break_link_from=!1,t.LiteGraph.click_do_break_link_to=!1,t.LiteGraph.search_hide_on_mouse_leave=!0,t.LiteGraph.search_filter_enabled=!0,t.LiteGraph.search_show_all_on_open=!0,t.LiteGraph.show_node_tooltip=!0,t.LiteGraph.show_node_tooltip_use_descr_property=!0,t.LiteGraph.auto_load_slot_types=!0,t.LiteGraph.alt_drag_do_clone_nodes=!0,t.LiteGraph.do_add_triggers_slots=!0,t.LiteGraph.allow_multi_output_for_events=!1,t.LiteGraph.middle_click_slot_add_default_node=!0,t.LiteGraph.release_link_on_empty_shows_menu=!0,t.LiteGraph.pointerevents_method="mouse",t.LiteGraph.ctrl_shift_v_paste_connect_unselected_outputs=!0,t.LiteGraph.backspace_delete=!1,t.LiteGraph.actionHistory_enabled=!1,t.LiteGraph.actionHistoryMaxSave=40,t.LiteGraph.showCanvasOptions=!0,t.LiteGraph.use_uuids=!0,t.LiteGraph.refreshAncestorsOnTriggers=!1,t.LiteGraph.refreshAncestorsOnActions=!1,t.LiteGraph.ensureUniqueExecutionAndActionCall=!1,t.LiteGraph.use_deferred_actions=!0,t.LiteGraph.context_menu_filter_enabled=!1,t.LiteGraph.reprocess_slot_while_node_configure=!1;class e{constructor(){this.listeners={}}on(t,e){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}off(t,e){const i=this.listeners[t];if(!i)return;const s=i.indexOf(e);-1!==s&&i.splice(s,1)}emit(t,...e){const i=this.listeners[t];i&&i.forEach((t=>{t(...e)}))}}const i="display",s="control";class r{constructor(){this.widgets=new Map}_createKey(t,e,i=void 0){return`${t}:${e}${i?`:${i}`:""}`}add(t,e,i=void 0){const s=t.capability,r=this._createKey(e,s,i);this.widgets.has(r)||this.widgets.set(r,new Set),this.widgets.get(r).add(t)}_getWidgetsByKey(t){return Array.from(this.widgets.get(t)||[])}get(t,e,i=void 0){const s=this._createKey(t,e,i),r=this._createKey(t,e,"*"),o=this._getWidgetsByKey(s),n=this._getWidgetsByKey(r);return Array.from(new Set([...o,...n]))}getDisplaysOfType(t,e=void 0){return this.get(t,i,e)}getControlsOfType(t,e=void 0){return this.get(t,s,e)}has(t,e,i=void 0){const s=this._createKey(t,e,i),r=this._createKey(t,e,"*");return this.widgets.has(s)||this.widgets.has(r)}hasDisplay(t,e){return this.has(t,i,e)}hasControl(t,e){return this.has(t,s,e)}remove(t,e,i=void 0){const s=this._createKey(t,e,i),r=this._createKey(t,e,"*");this.widgets.delete(s),this.widgets.delete(r)}[Symbol.iterator](){const t=this.widgets.entries();return{next:()=>{const{done:e,value:i}=t.next();if(e)return{done:e};const[s,r]=i,[o,n,a]=s.split(":");return{value:[o,n,a,Array.from(r)],done:!1}}}}}class o{constructor(){this.handlers=[]}addHandler(t){this.handlers.push(t)}removeHandler(t){const e=this.handlers.indexOf(t);e>-1&&this.handlers.splice(e,1)}handle(t,e){let i=0;const s=()=>{if(i<this.handlers.length){this.handlers[i++].handle(t,e,s)}};s()}}class n{handle(t,e,i){i()}}function a(t){let e=t.identifier?`${t.typeName} (${t.identifier})`:t.typeName;return t.baseDatatype&&(e+=`,${a(t.baseDatatype)}`),e}class l extends n{handle(t,e,i){e.inputPorts&&e.inputPorts.forEach((e=>{const i=a(e.datatype);t.addInput(e.name,i)})),i()}}class h extends n{handle(t,e,i){e.outputPorts&&e.outputPorts.forEach((e=>{const i=a(e.datatype);t.addOutput(e.name,i)})),i()}}class d extends n{constructor(t){super(),this.widgets=t}handle(t,e,i){const s=new Set(e.contents?e.contents.map((t=>t.name)):[]);e.parameters&&e.parameters.forEach((i=>{const r=i.name,o=i.datatype.typeName,n=i.datatype.identifier,a=i.datatype.identifier?`${i.datatype.typeName} (${i.datatype.identifier})`:i.datatype.typeName,l=i.defaultValue,h=t.addProperty(r,l,a);let d;s.has(r)&&(d=e.contents.find((t=>t.name===r)));const u=this.widgets.getControlsOfType(o,n);if(!u.length)throw new Error(`Unable to find widget of type :  ${a}`);const c=new u[0](r,t,{property:h,parameter:i,content:d});t.addCustomWidget(c)})),i()}}class u extends n{constructor(t){super(),this.widgets=t}handle(t,e,i){const s=new Set(e.parameters?e.parameters.map((t=>t.name)):[]);e.contents&&e.contents.forEach((e=>{if(s.has(e.name))return;const i=e.name,r=e.datatype.typeName,o=e.datatype.identifier||"",n=e.datatype.identifier?`${e.datatype.typeName} (${e.datatype.identifier})`:e.datatype.typeName,a=this.widgets.getDisplaysOfType(r,o);if(!a.length)throw new Error(`Unable to find widget of type :  ${n}`);const l=new a[0](i,t,{content:e});t.addCustomWidget(l)})),i()}}class c extends t.LGraphNode{eventEmitter=new e;constructor(t){super(t),this._shape=2,this.extensions=[],this.registerCallbackHandlers();(new g).applyExtensions("node",this),this.eventEmitter.emit("constructorComplete",this)}addCustomWidget(t){super.addCustomWidget(t),t.registerWithParent&&t.registerWithParent(this),this.eventEmitter.emit("customWidgetAdded",t)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}update(t){this.eventEmitter.emit("nodeStatusUpdated",t)}setPropertyDefaultValue(t,e){if(this.properties||={},e===this.properties[t])return;this.properties[t]=e;const i=this.widgets?.find((e=>e&&e.options?.property===t));i&&(i.value=e)}resetSize(){this.setSize(this.computeSize())}onDropFile(e,i=null){if(this.widgets&&this.widgets.length)if(null!==i){const t=this.widgets.find((t=>t.name===i));if(t&&t.onDropFile&&t.onDropFile(e))return void this.eventEmitter.emit("dropFileHandledByWidget",e,t)}else for(const t of this.widgets)if(t.onDropFile&&t.onDropFile(e))return void this.eventEmitter.emit("dropFileHandledByWidget",e,t);t.LiteGraph.log_warn(`Node ${this.type} was registered to handle a dropped file, but failed to handle it.`)}registerCallbackHandlers(){this.registerCallbackHandler("onAdded",(t=>{this.eventEmitter.emit("added",this)})),this.registerCallbackHandler("onRemoved",(t=>{this.eventEmitter.emit("removed",this)})),this.registerCallbackHandler("onPropertyChanged",((t,e,i,s)=>{this.eventEmitter.emit("propertyChanged",this,e,i,s)}))}applyExtension(t){this.eventEmitter.emit("applyExtension",t);try{const e=new t(this);this.extensions.push(e)}catch(e){if("object"!=typeof t||"function"!=typeof t.apply)throw new Error("Extension must be a class or an object with an apply method");t.apply(this),this.extensions.push(t)}}}class p{constructor(t){this.widgets=t,this.handlers=new o}registerHandler(t){this.handlers.addHandler(t)}removeHandler(t){this.handlers.removeHandler(t)}validateBlueprint(t){return[this.checkBlueprintHasPath.bind(this),this.checkBlueprintParametersAreSupported.bind(this),this.checkBlueprintContentsAreSupported.bind(this)].every((e=>e(t)))}getNodeNameFromBlueprint(t){return t.path.split("/").pop()}getNodePathFromBlueprint(t){return t.path.split("/").slice(0,-1).join("/")}getNodeTypeFromBlueprint(t){return t.path}checkBlueprintHasPath(t){return t.path}checkBlueprintParametersAreSupported(t){return!t.node.parameters||t.node.parameters.every((t=>{const{typeName:e,identifier:i}=t.datatype;return this.widgets.hasControl(e,i)}))}checkBlueprintContentsAreSupported(t){if(!t.node.contents)return!0;const e=new Set((t.node?.parameters||[]).map((t=>`${t.datatype.typeName}-${t.datatype.identifier}`)));return t.node.contents.every((t=>{const{typeName:i,identifier:s}=t.datatype,r=`${i}-${s}`;return!(!e.has(r)||!this.widgets.hasControl(i,s))||this.widgets.hasDisplay(i,s)}))}create(t){if(!this.validateBlueprint(t))return;const e=this,i=e.getNodeNameFromBlueprint(t);return class extends c{static title=i;static desc="";constructor(){super(i),e.handlers.handle(this,t.node)}}}}class g{static instance;constructor(){if(g.instance)return g.instance;if(void 0===t.LiteGraph)throw new Error("LiteGraph is not available in the global scope.");return this.liteGraph=t.LiteGraph,this.liteGraph.initialize(),this.nodeExtensions=[],this.canvasExtensions=[],this.editorExtensions=[],this.widgets=new r,this.nodeClassFactory=new p(this.widgets),this.nodeClassFactory.registerHandler(new l),this.nodeClassFactory.registerHandler(new h),this.nodeClassFactory.registerHandler(new d(this.widgets)),this.nodeClassFactory.registerHandler(new u(this.widgets)),this.liteGraph.computeTextWidth=function(t,e){if(!t)return 0;let i=t.toString();return void 0===e?this.NODE_TEXT_SIZE*i.length*.6:this.NODE_TEXT_SIZE*i.length*e},g.instance=new Proxy(this,{get:(t,e,i)=>Reflect.has(t,e)?Reflect.get(t,e,i):(...i)=>"function"==typeof t.liteGraph[e]?t.liteGraph[e].apply(t.liteGraph,i):t.liteGraph[e]}),g.instance}install(t,e){t.install(this,e)}installNodeBlueprints(t){t&&Array.isArray(t)&&t.forEach((t=>{this.installNodeBlueprint(t)}))}installNodeBlueprint(t){if(t){const e=this.nodeClassFactory.getNodeTypeFromBlueprint(t);if(!e)return void this.log_warn("Failed to determine node type from blueprint.");const i=this.nodeClassFactory.create(t);if(!i)return void this.log_warn("Unable to create node class from blueprint.",e,t);this.registerNodeType(e,i)}else this.log_warn("No blueprint provided to installNodeBlueprint.")}registerWidgetType(t,e,i){this.widgets.add(t,e,i)}registerFileAssociation(t,e,i=null){for(let s of t)s&&"string"==typeof s&&(this.liteGraph.node_types_by_file_extension[s.toLowerCase()]={type:e,widgetName:i})}registerNodeExtension(t){this.nodeExtensions.push(t)}registerCanvasExtension(t){this.canvasExtensions.push(t)}registerEditorExtension(t){this.editorExtensions.push(t)}applyExtensions(t,e){let i;switch(t){case"node":i=this.nodeExtensions;break;case"canvas":i=this.canvasExtensions;break;case"editor":i=this.editorExtensions;break;default:throw new Error(`Unknown extension type: ${t}`)}i.forEach((t=>e.applyExtension(t)))}getVersion(){return this.liteGraph.VERSION}}class m{static Convert(t){const e=JSON.parse(JSON.stringify(t.serialize())),i=this.#t(e.nodes),s=this.#e(i,e.links);return this.#i({...e,nodes:i,links:s})}static#t(t){return t.map((t=>({...t,id:String(t.id)})))}static#e(t,e){return e.map((e=>{const[i,s,r,o,n,a]=e,l=String(i),h=String(s),d=String(o),u=t.find((t=>t.id===h)),c=t.find((t=>t.id===d)),p=u&&u.outputs[r]?.name||"unknown",g=c&&c.inputs[n]?.name||"unknown";return[l,h,p,d,g,a]}))}static#i(t){const{extra:e,version:i,config:s,last_node_id:r,last_link_id:o,...n}=t;return n.nodes=n.nodes.map((t=>{const{flags:e,shape:i,size:s,pos:r,properties:o,inputs:n,outputs:a,...l}=t;return o&&Object.keys(o).length&&(l.properties=o),n&&n.length&&(l.inputs=n),a&&a.length&&(l.outputs=a),l})),n}}class f extends t.LGraph{#s=null;constructor(t){super(t),this.eventEmitter=new e,this.#s=null,this.updateGraphUuid()}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}get uuid(){return this.#s}get isEmpty(){return 0===this._nodes.length}updateGraphUuid(){this.#s=t.LiteGraph.uuidv4()}update(t){const e=t&&Array.isArray(t.nodes)?new Map(t.nodes.map((t=>[t.id,t]))):new Map;this._nodes.forEach((t=>{const i=e.get(t.id)||{};t.update(i)}))}serialize(){let t=super.serialize();return t.uuid=this.#s,t}exportForBackend(){return m.Convert(this)}onNodeAdded(t){this.updateGraphUuid(),t.on("propertyChanged",this.emitOnNodePropertyChange.bind(this)),this.eventEmitter.emit("nodeAdded",this,t)}onNodeRemoved(t){this.updateGraphUuid(),t.off("propertyChanged",this.emitOnNodePropertyChange.bind(this)),this.eventEmitter.emit("nodeRemoved",this,t)}onConnectionChange(t){this.updateGraphUuid(),this.eventEmitter.emit("connectionChange",this,t)}onBeforeChange(){this.eventEmitter.emit("beforeChange",this)}onAfterChange(){this.eventEmitter.emit("afterChange",this)}emitOnNodePropertyChange(t,e,i,s){this.eventEmitter.emit("nodePropertyChanged",this,t,e,i,s)}}class y{constructor(t,e,i,s){this.id=t,this.label=e,this.iconUrl=i,this.onClick=s}render(){const t=document.createElement("button");return t.id=this.id,t.classList.add("mgui-toolbar-button"),this.iconUrl&&(t.innerHTML=`<img src="${this.iconUrl}" alt="${this.label} icon"/> `),t.innerHTML+=this.label,this.onClick&&t.addEventListener("click",this.onClick),t}}class v{constructor(t){this.editor=t,this.connection=t.getConnection(),this.setupToolbarControls()}setupToolbarControls(){const t=new g,e=new y("GetBlueprints","Get Blueprints",null,(async()=>{console.log("api get blueprints");try{const e=await this.connection.send("GetBlueprints");console.log("api get blueprints reply",e),t.installNodeBlueprints(e.blueprints)}catch(t){console.error("api get blueprints failed:",t)}}));this.editor.addToolbarControl(e)}}class C{constructor(t){this.editor=t,this.connection=t.getConnection(),this.currentGraph=null,this.pollingTimeoutId=null,this.pollingPeriodInMs=1e3,this.requestQueueMaxSize=1,this.requestQueue=[],this.processingRequest=!1,this.setupEditorListeners(),this.setupToolbarControls(),this.switchGraph(this.editor.getGraph())}setupEditorListeners(){this.editor.on("graphSet",(t=>{this.switchGraph(t)}))}setupToolbarControls(){}switchGraph(t){this.currentGraph&&this.unregisterGraphListeners(this.currentGraph),this.currentGraph=t,this.currentGraph&&this.registerGraphListeners(t)}unregisterGraphListeners(t){t.off("connectionChange",this.handleConnectionChange.bind(this)),t.off("nodeAdded",this.handleNodeAdded.bind(this)),t.off("nodeRemoved",this.handleNodeRemoved.bind(this)),t.off("nodePropertyChanged",this.handlePropertyChange.bind(this))}registerGraphListeners(t){t.on("connectionChange",this.handleConnectionChange.bind(this)),t.on("nodeAdded",this.handleNodeAdded.bind(this)),t.on("nodeRemoved",this.handleNodeRemoved.bind(this)),t.on("nodePropertyChanged",this.handlePropertyChange.bind(this))}enqueueRequest(t,...e){this.requestQueue.length>=this.requestQueueMaxSize&&(this.requestQueue=this.requestQueue.slice(1-this.requestQueueMaxSize)),this.requestQueue.push({requestFunction:t,args:e}),this.processRequests()}async processRequests(){if(this.processingRequest||0===this.requestQueue.length)return;this.processingRequest=!0;const{requestFunction:t,args:e}=this.requestQueue.shift();try{await t.apply(this,e)}finally{this.processingRequest=!1,this.processRequests()}}handleConnectionChange(t,e){t.uuid==this.currentGraph.uuid&&this.enqueueRequest(this.createGraph,t)}handleNodeAdded(t,e){t.uuid==this.currentGraph.uuid&&this.enqueueRequest(this.createGraph,t)}handleNodeRemoved(t,e){t.uuid==this.currentGraph.uuid&&this.enqueueRequest(this.createGraph,t)}handlePropertyChange(t,e,i,s){t.uuid==this.currentGraph.uuid&&this.enqueueRequest(this.updateParameterValue,t,e,i,s)}async createGraph(t){this.stopPolling();const e=t.exportForBackend();console.log("api create graph",t.uuid,e);try{const i=await this.connection.send("CreateGraph",{graph:e});i.uuid===t.uuid&&(t.update(i),this.startPolling())}catch(t){console.error(t)}}async updateParameterValue(t,e,i,s){this.stopPolling(),console.log("api update property",e,i,s);try{await this.connection.send("UpdateParameterValue",{graphUuid:t.uuid,nodeId:e.id,parameterName:i,parameterValue:s});this.startPolling()}catch(e){e.message.includes("Invalid or missing graphUuid")?(console.log("api update property failed due to unknown graphUuid, triggering update graph"),await this.createGraph(t)):console.error("Update parameter value failed:",e)}}stopPolling(){this.pollingTimeoutId&&(clearTimeout(this.pollingTimeoutId),this.pollingTimeoutId=null,console.log("polling stopped"))}isPolling(){return Boolean(this.pollingTimeoutId)}startPolling(){if(this.currentGraph.isEmpty)return void this.stopPolling();const t=async()=>{if(this.isPolling())try{const e=await this.connection.send("GetStatus",{graphUuid:this.currentGraph.uuid});if(console.log("polling reply >",e),e.uuid!==this.currentGraph.uuid)return console.log("polling reply rejected as graph uuid mismatch"),void this.stopPolling();this.currentGraph.update(e),this.pollingTimeoutId=setTimeout(t,this.pollingPeriodInMs)}catch(t){console.error("polling error",t),this.stopPolling()}};console.log("polling started"),this.pollingTimeoutId=setTimeout(t,this.pollingPeriodInMs)}}class b{constructor(t){this.editor=t,this.editorCanvas=t.getGraphCanvas(),this.setupToolbarControls()}setupToolbarControls(){const t=new y("ToggleExecuteOrder","Toggle Execution Order",null,(()=>{this.editorCanvas.render_execution_order=!this.editorCanvas.render_execution_order,this.editorCanvas.setDirty(!0,!0)}));this.editor.addToolbarControl(t)}}class x{constructor(t){this.node=t,this.defaultColor=t.color,this.defaultBgColor=t.bgcolor,this.defaultTooltip=t.properties.tooltip,this.errorStyle={bgcolor:"#96000c",color:"#750000"},t.on("nodeStatusUpdated",this.handleStatusUpdate.bind(this))}hasPrecheckAlarms(t){if(Array.isArray(t.extensions))for(let e of t.extensions)if("precheck"===e.name&&Array.isArray(e.alarms)&&e.alarms.length>0)return!0;return!1}getFirstAlarm(t){for(const e of t.extensions??[])if("precheck"===e.name&&e.alarms?.length>0){const t=e.alarms[0];return`${t.message} : ${t.reason}`}return null}handleStatusUpdate(t){const e=this.node.color,i=this.node.bgcolor;this.hasPrecheckAlarms(t)?(this.node.color=this.errorStyle.color,this.node.bgcolor=this.errorStyle.bgcolor,this.node.properties.tooltip=this.getFirstAlarm(t)):(this.node.color=this.defaultColor,this.node.bgcolor=this.defaultBgColor,this.node.properties.tooltip=this.defaultTooltip),e===this.node.color&&i===this.node.bgcolor||this.node.setDirtyCanvas(!0,!0)}}exports.CheckboxComponent=class{constructor(t,i,s){this.eventEmitter=new e,this.label=t,this.colorGenerator=s,this._isChecked=i,this.setupDefaults()}setupDefaults(){this.labelFont="12px Arial",this.labelTextColor=this.colorGenerator.getLabelColor(),this.margin=20,this.outlineColor=this.colorGenerator.getBorderColor(),this.backgroundColor=this.colorGenerator.getBackgroundColor(),this.checkboxSize=20,this.checkboxMargin=5,this.checkboxColor=this.colorGenerator.getValueColor(),this.checkboxX=0,this.checkboxY=0,this.labelEndPosition=0}get isChecked(){return this._isChecked}set isChecked(t){this._isChecked=t,this.eventEmitter.emit("onChange",this._isChecked)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}isClickInZone(t){return t[0]>=this.checkboxX&&t[0]<=this.checkboxX+this.labelEndPosition&&t[1]>=this.checkboxY&&t[1]<=this.checkboxY+this.checkboxSize}onMouse(t,e){"pointerdown"===t.type&&this.isClickInZone(e)&&(this.isChecked=!this.isChecked)}computeSize(){return new Float32Array([220,20])}draw(t,e,i,s,r){this.drawLabel(t,s,r),this.drawCheckbox(t,s,r)}drawLabel(t,e,i){t.font=this.labelFont,t.fillStyle=this.labelTextColor;const s=2*this.margin+5;t.fillText(this.label,s,e+.7*i);const r=s+t.measureText(this.label).width;this.labelEndPosition=r}drawCheckbox(t,e,i){this.checkboxY=e+(i-this.checkboxSize)/2,this.checkboxX=this.margin,t.fillStyle=this.backgroundColor,t.strokeStyle=this.outlineColor,t.beginPath(),t.roundRect(this.checkboxX,this.checkboxY,this.checkboxSize,this.checkboxSize,2),t.fill(),t.stroke(),this._isChecked&&(t.strokeStyle=this.checkboxColor,t.beginPath(),t.moveTo(this.checkboxX+3,this.checkboxY+this.checkboxSize/2),t.lineTo(this.checkboxX+this.checkboxSize/3,this.checkboxY+this.checkboxSize-3),t.lineTo(this.checkboxX+this.checkboxSize-3,this.checkboxY+3),t.stroke())}},exports.ColorGenerator=class{LABEL_BRIGHTNESS=70;LABEL_SATURATION=0;VALUE_BRIGHTNESS=90;VALUE_SATURATION=0;BORDER_BRIGHTNESS=50;BORDER_SATURATION=0;BACKGROUND_BRIGHTNESS=10;BACKGROUND_SATURATION=0;constructor(t,e=""){this.type=t,this.other=e}generateHsl(t,e){let i=0;for(let t=0;t<this.type.length;t++)i=this.type.charCodeAt(t)+((i<<5)-i);for(let t=0;t<this.other.length;t++)i=this.other.charCodeAt(t)+((i<<5)-i);return`hsl(${Math.abs(i)%360}, ${t}%, ${e}%)`}getLabelColor(){return this.generateHsl(this.LABEL_SATURATION,this.LABEL_BRIGHTNESS)}getValueColor(){return this.generateHsl(this.VALUE_SATURATION,this.VALUE_BRIGHTNESS)}getBorderColor(){return this.generateHsl(this.BORDER_SATURATION,this.BORDER_BRIGHTNESS)}getBackgroundColor(){return this.generateHsl(this.BACKGROUND_SATURATION,this.BACKGROUND_BRIGHTNESS)}},exports.ComboboxComponent=class{constructor(t,i,s,r){this.eventEmitter=new e,this.label=t,this.options=s,this.colorGenerator=r,this._selection=i,this.setupDefaults()}setupDefaults(){this.labelFont="12px Arial",this.labelTextColor=this.colorGenerator.getLabelColor(),this.valueFont="12px Arial",this.valueTextColor=this.colorGenerator.getValueColor(),this.margin=20,this.outlineColor=this.colorGenerator.getBorderColor(),this.backgroundColor=this.colorGenerator.getBackgroundColor()}get selection(){return this._text}set selection(t){this._selection=t,this.eventEmitter.emit("onChange",this._selection)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}onMouse(e,i){const s=this;if("pointerdown"===e.type){var r=e.target.data.getCanvasWindow();new t.LiteGraph.ContextMenu(this.options,{scale:1,event:e,className:"dark",callback:function(t){s.selection=t}},r)}}computeSize(){let e=new Float32Array([220,20]);var i=0;return this.options.forEach((e=>{i=Math.max(i,t.LiteGraph.computeTextWidth(e,.6))})),e[0]=i,e[0]+=t.LiteGraph.computeTextWidth(this.label),e[0]+=70,e[1]=t.LiteGraph.NODE_WIDGET_HEIGHT,e}draw(t,e,i,s,r){t.textAlign="left";const o=i-2*this.margin;this.drawBackground(t,s,o,r),this.drawLabel(t,s,r),this.drawValue(t,o,s,r),this.drawDownArrow(t,s,i,r)}drawBackground(t,e,i,s){t.strokeStyle=this.outlineColor,t.fillStyle=this.backgroundColor,t.beginPath(),t.roundRect(this.margin,e,i,s,2),t.fill(),t.stroke()}drawLabel(t,e,i){t.font=this.labelFont,t.fillStyle=this.labelTextColor,t.fillText(this.label,this.margin+10,e+.7*i)}drawDownArrow(t,e,i,s){t.fillStyle=this.arrowColor,t.beginPath(),t.moveTo(i-this.margin-12,e+s-5),t.lineTo(i-this.margin-18,e+5),t.lineTo(i-this.margin-6,e+5),t.fill()}drawValue(t,e,i,s){t.font=this.valueFont,t.fillStyle=this.valueTextColor,t.textAlign="right",t.fillText(this._selection,e-5,i+.7*s)}},exports.ControlWidget=class{static capability=s;#r=null;#o=null;#n=null;constructor(t,e,i={}){this.value=null,this.options=i,this.name=t,this.#r=e,this.#o=i.property,this.#n=i.parameter}setValue(t){this.value=t,this.#r&&this.#o&&this.#o.name&&(this.#r?.setProperty(this.#o.name,t),this.#r?.setDirtyCanvas(!0,!0))}getValue(){return this.value}setDefaultValue(t){this.value=t,this.#r&&this.#o&&this.#o.name&&(this.#r?.setPropertyDefaultValue(this.#o.name,t),this.#r?.setDirtyCanvas(!0,!0))}triggerParentResetSize(){this.#r&&this.#r.resetSize()}},exports.DefaultPack=class{install(t=new g,e){this.registerBundledPacks(t,e),this.registerGraphExtensions(t,e),this.registerCanvasExtensions(t,e),this.registerEditorExtensions(t,e),this.registerNodeExtensions(t,e),this.registerWidgets(t,e)}registerBundledPacks(t,e={}){}registerGraphExtensions(t,e={}){}registerCanvasExtensions(t,e={}){}registerEditorExtensions(t,e={}){t.registerEditorExtension(v),t.registerEditorExtension(C),t.registerEditorExtension(b)}registerNodeExtensions(t,e={}){t.registerNodeExtension(x)}registerWidgets(t,e={}){}registerFileAssociation(t,e={}){}},exports.DisplayWidget=class{static capability=i;#r=null;#a=null;constructor(t,e,i={}){this.options=i,this.name=t,this.#r=e,this.#a=i.content,this.registerForContentUpdates()}onContentUpdate(t){}registerForContentUpdates(){this.#a&&this.#r&&this.#r.on("nodeStatusUpdated",(t=>{const e=t.contents?.find((t=>t.name===this.#a.name))?.value;this.onContentUpdate(e),this.#r?.setDirtyCanvas(!0,!0)}))}triggerParentResetSize(){this.#r&&this.#r.resetSize()}},exports.GraphEditor=class{constructor(t,i){this.eventEmitter=new e,this.connection=i,this.rootElement=null,this.parentDiv=null,this.toolbarElement=null,this.mainWindowElement=null,this.footerElement=null,this.canvasElement=null,this.graphCanvas=null,this.graph=new f,this.toolbarControls=[],this.extensions=[],this.makeEditorWindow(t),this.setGraph(this.graph);return(new g).applyExtensions("editor",this),this.eventEmitter.emit("instantiated",this),this.graph}getConnection(){return this.connection}getGraph(){return this.graph}getGraphCanvas(){return this.graphCanvas}setGraph(t){return this.graph&&this.eventEmitter.emit("graphReplaced",this.graph),this.graph=t,this.graphCanvas.setGraph(this.graph,!0),this.eventEmitter.emit("graphSet",this.graph),t}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}addToolbarControl(t){this.toolbarControls.push(t);const e=t.render();this.toolbarElement.appendChild(e),this.resizeCanvas()}applyExtension(t){this.eventEmitter.emit("applyExtension",t);try{const e=new t(this);this.extensions.push(e)}catch(e){if("object"!=typeof t||"function"!=typeof t.apply)throw new Error("Extension must be a class or an object with an apply method");t.apply(this),this.extensions.push(t)}}makeEditorWindow(e,i={}){const s=this.rootElement=document.createElement("div");s.className="mgui-editor",s.innerHTML='\n    <div class="mgui-editor-toolbar">\n        <div class="mgui-editor-tools mgui-editor-tools-left"></div>\n        <div class="mgui-editor-tools mgui-editor-tools-right"></div>\n    </div>\n    <div class="mgui-editor-main-window">\n        <canvas class="mgui-editor-graphcanvas"></canvas>    \n    </div>\n    <div class="mgui-editor-footer">\n        <div class="mgui-editor-tools mgui-editor-tools-left"></div>\n        <div class="mgui-editor-tools mgui-editor-tools-right"></div>\n    </div>',this.toolbarElement=s.querySelector(".mgui-editor-toolbar"),this.mainWindowElement=s.querySelector(".mgui-editor-main-window"),this.footerElement=s.querySelector(".mgui-editor-footer");const r=this.canvasElement=s.querySelector(".mgui-editor-graphcanvas");if(this.graphCanvas=new t.LGraphCanvas(r),this.graphCanvas.render_canvas_border=!1,this.parentDiv=document.getElementById(e),!this.parentDiv)throw new Error("Editor has no parentElement to bind to");this.parentDiv?.appendChild(s),this.resizeCanvas(),window.addEventListener("resize",this.resizeCanvas.bind(this))}resizeCanvas(){const t=this.parentDiv.clientHeight-this.toolbarElement.offsetHeight-this.footerElement.offsetHeight;this.mainWindowElement.style.height=t+"px",this.canvasElement.height=t,this.canvasElement.style.height=t+"px",this.graphCanvas.resize()}},exports.GraphFramework=g,exports.LedComponent=class{constructor(t,e,i){this.label=t,this.colorGenerator=i,this._isActive=e,this.setupDefaults()}setupDefaults(){this.labelFont="12px Arial",this.labelTextColor=this.colorGenerator.getLabelColor(),this.margin=20,this.outlineColor=this.colorGenerator.getBorderColor(),this.valueFont="12px Arial",this.valueTextColor=this.colorGenerator.getValueColor(),this.trueIndicatorColor="#39e75f",this.falseIndicatorColor="#777"}get isActive(){return this._isActive}set isActive(t){this._isActive=t}computeSize(){return new Float32Array([220,20])}draw(t,e,i,s,r){const o=i-2*this.margin;this.drawLabel(t,s,r),this.drawValue(t,o,s,r),this.drawIndicator(t,o,s,r)}drawLabel(t,e,i){t.font=this.labelFont,t.fillStyle=this.labelTextColor,t.fillText(this.label,this.margin,e+.7*i)}drawValue(t,e,i,s){t.font=this.valueFont,t.fillStyle=this.valueTextColor,t.textAlign="right",t.fillText(this._isActive?"true":"false",e+this.margin-20,i+.7*s)}drawIndicator(t,e,i,s){const r=this._isActive?this.trueIndicatorColor:this.falseIndicatorColor,o=.6*s,n=t.createRadialGradient(e+this.margin-5,i+.5*s,0,e+this.margin-5,i+.5*s,o);n.addColorStop(0,r),n.addColorStop(1,"rgba(0, 0, 0, 0)"),this._isActive&&(t.fillStyle=n,t.beginPath(),t.arc(e+this.margin-5,i+.5*s,o,0,2*Math.PI),t.fill()),t.fillStyle=r,t.beginPath(),t.arc(e+this.margin-5,i+.5*s,.35*s,0,2*Math.PI),t.fill(),t.strokeStyle="#222",t.stroke()}},exports.NumberLimiter=class{#l;#h;#d;#u;#c;#p;#g;constructor(t,e,i,s=null,r=2){this.#l=t,this.#h=e,this.#d=i,this.#u=s,this.#c=r,this.#m(),this.setValue(this.#d)}#f(t){return"odd"===this.#u&&t%2==0||"even"===this.#u&&t%2!=0}#y(t,e){return this.#f(t)?t+e:t}#m(){this.#p=this.#y(this.#l,1),this.#g=this.#y(this.#h,-1)}setValue(t){this.#f(t)&&(t+=1),t=parseFloat(t.toFixed(this.#c)),this.#d=Math.min(Math.max(t,this.#p),this.#g)}incrementBy(t){this.#f(this.#d+t)&&(t+=1),this.setValue(this.#d+t)}decrementBy(t){this.#f(this.#d-t)&&(t+=1),this.setValue(this.#d-t)}getValue(){return this.#d}},exports.NumericDisplayComponent=class{constructor(t,e,i,s){this.label=t,this.precision=i,this.colorGenerator=s,this._value=e,this.setupDefaults()}setupDefaults(){this.labelFont="12px Arial",this.valueFont="12px Arial",this.margin=20,this.labelTextColor=this.colorGenerator.getLabelColor(),this.valueTextColor=this.colorGenerator.getValueColor()}get value(){return this._value}set value(t){this._value=t}computeSize(){return new Float32Array([220,20])}draw(t,e,i,s,r){t.textAlign="left";const o=i-2*this.margin;this.drawLabel(t,s,r),this.drawValue(t,o,s,r)}drawLabel(t,e,i){t.font=this.labelFont,t.fillStyle=this.labelTextColor,t.fillText(this.label,this.margin,e+.7*i)}drawValue(t,e,i,s){t.font=this.valueFont,t.fillStyle=this.valueTextColor,t.textAlign="right",t.fillText(Number(this._value).toFixed(this.precision),e+this.margin-5,i+.7*s)}},exports.NumericInputComponent=class{constructor(t,i,s,r,o){this.eventEmitter=new e,this.label=t,this.precision=s,this.limiter=r,this.colorGenerator=o,this._value=i,this.isDragging=!1,this.startX=0,this.step=this.calculateStep(s),this.setupDefaults()}setupDefaults(){this.labelFont="12px Arial",this.valueFont="12px Arial",this.margin=20,this.labelTextColor=this.colorGenerator.getLabelColor(),this.valueTextColor=this.colorGenerator.getValueColor(),this.outlineColor=this.colorGenerator.getBorderColor(),this.backgroundColor=this.colorGenerator.getBackgroundColor(),this.arrowColor=this.colorGenerator.getValueColor()}get value(){return this._value}set value(t){this._value=t,this.eventEmitter.emit("onChange",this._value)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}computeSize(){return new Float32Array([220,20])}onMouse(t,e,i){const s=e[0],r=i.size[0],o=this.getMultiplier(t);"pointerdown"===t.type?this.handleMouseDown(s,r,o):"pointermove"===t.type?this.handleMouseMove(s,o):"pointerup"===t.type&&this.handleMouseUp(s,r,t)}calculateStep(t){return Math.pow(10,-Math.abs(t))}getMultiplier(t){return t.shiftKey&&t.ctrlKey?100:t.shiftKey?10:1}handleMouseDown(t,e,i){this.isMyMouseEvent=!0,this.isDragging=!1,this.startX=t,this.adjustValueByPosition(t,e,i)}handleMouseMove(t,e){if(this.isMyMouseEvent&&Math.abs(t-this.startX)>1){const i=Math.floor(t-this.startX);this.limiter.incrementBy(i*this.step*e),this._value=this.limiter.getValue(),this.startX=t,this.isDragging=!0}}handleMouseUp(t,e,i){!this.isDragging&&this.isInsideInputArea(t,e)&&this.promptForValue(i),this.isDragging=!1,this.isMyMouseEvent=!1,this.updateValueOnRelease()}isInsideInputArea(t,e){return t>40&&t<e-40}adjustValueByPosition(t,e,i){t<40?this.limiter.decrementBy(this.step*i):t>e-40&&this.limiter.incrementBy(this.step*i),this._value=this.limiter.getValue()}promptForValue(t){let e=this;t.target.data.prompt("Value",this.value.toString(),(function(t){const i=Number(t);isNaN(i)?console.error("Invalid input: Input is not a number."):(e.limiter.setValue(i),e.value=e.limiter.getValue(),e.updateValueOnRelease())}),t)}updateValueOnRelease(){this.limiter.setValue(this.value),this.value=this.limiter.getValue()}draw(t,e,i,s,r){t.textAlign="left";const o=i-2*this.margin;this.drawBackground(t,s,o,r),this.drawLeftArrow(t,s,r),this.drawRightArrow(t,s,i,r),this.drawLabel(t,s,r),this.drawValue(t,o,s,r)}drawBackground(t,e,i,s){t.strokeStyle=this.outlineColor,t.fillStyle=this.backgroundColor,t.beginPath(),t.roundRect(this.margin,e,i,s,2),t.fill(),t.stroke()}drawLeftArrow(t,e,i){t.fillStyle=this.arrowColor,t.beginPath(),t.moveTo(this.margin+16,e+5),t.lineTo(this.margin+6,e+.5*i),t.lineTo(this.margin+16,e+i-5),t.fill()}drawRightArrow(t,e,i,s){t.fillStyle=this.arrowColor,t.beginPath(),t.moveTo(i-this.margin-16,e+5),t.lineTo(i-this.margin-6,e+.5*s),t.lineTo(i-this.margin-16,e+s-5),t.fill()}drawLabel(t,e,i){t.font=this.labelFont,t.fillStyle=this.labelTextColor,t.fillText(this.label,2*this.margin+5,e+.7*i)}drawValue(t,e,i,s){t.font=this.valueFont,t.fillStyle=this.valueTextColor,t.textAlign="right",t.fillText(Number(this._value).toFixed(this.precision),e-5,i+.7*s)}},exports.SingleLineTextDisplayComponent=class{constructor(t,e,i){this.label=t,this.colorGenerator=i,this._text=e,this.setupDefaults()}setupDefaults(){this.labelFont="12px Arial",this.labelTextColor=this.colorGenerator.getLabelColor(),this.valueFont="12px Arial",this.valueTextColor=this.colorGenerator.getValueColor(),this.margin=20,this.outlineColor=this.colorGenerator.getBorderColor(),this.backgroundColor=this.colorGenerator.getBackgroundColor()}get text(){return this._text}set text(t){this._text=t}computeSize(){return new Float32Array([220,20])}draw(t,e,i,s,r){t.textAlign="left";const o=i-2*this.margin;this.drawLabel(t,s,r),this.drawText(t,o,s,r)}drawLabel(t,e,i){t.font=this.labelFont,t.fillStyle=this.labelTextColor,t.fillText(this.label,this.margin,e+.7*i)}drawText(t,e,i,s){t.font=this.valueFont,t.fillStyle=this.valueTextColor,t.textAlign="right",t.fillText(this._text,e+this.margin,i+.7*s)}},exports.SingleLineTextInputComponent=class{constructor(t,i,s){this.eventEmitter=new e,this.label=t,this.colorGenerator=s,this._text=i,this.setupDefaults()}setupDefaults(){this.labelFont="12px Arial",this.labelTextColor=this.colorGenerator.getLabelColor(),this.valueFont="12px Arial",this.valueTextColor=this.colorGenerator.getValueColor(),this.margin=20,this.outlineColor=this.colorGenerator.getBorderColor(),this.backgroundColor=this.colorGenerator.getBackgroundColor()}get text(){return this._text}set text(t){this._text=t,this.eventEmitter.emit("onChange",this._text)}on(t,e){this.eventEmitter.on(t,e)}off(t,e){this.eventEmitter.off(t,e)}onMouse(t,e){const i=this;"pointerdown"===t.type&&t.target.data.prompt("Value",this._text,(function(t){i.text=t}),t)}computeSize(){return new Float32Array([220,20])}draw(t,e,i,s,r){t.textAlign="left";const o=i-2*this.margin;this.drawBackground(t,s,o,r),this.drawLabel(t,s,r),this.drawText(t,o,s,r)}drawBackground(t,e,i,s){t.strokeStyle=this.outlineColor,t.fillStyle=this.backgroundColor,t.beginPath(),t.roundRect(this.margin,e,i,s,2),t.fill(),t.stroke()}drawLabel(t,e,i){t.font=this.labelFont,t.fillStyle=this.labelTextColor,t.fillText(this.label,this.margin+10,e+.7*i)}drawText(t,e,i,s){t.font=this.valueFont,t.fillStyle=this.valueTextColor,t.textAlign="right",t.fillText(this._text,this.margin+e-10,i+.7*s)}};
